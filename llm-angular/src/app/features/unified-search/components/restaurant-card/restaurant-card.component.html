<article class="restaurant-card" [class.selected]="selected()" [class.top-result]="isTopResult()"
  [class.compact]="compact()" role="button" tabindex="0" [attr.aria-label]="'View details for ' + restaurant().name">

  @if (showReasonLabel() && isTopResult()) {
  <app-reason-label [restaurant]="restaurant()" />
  }

  <!-- Main content area (clickable for details) -->
  <div class="card-content" (click)="onCardClick()">
    <div class="card-header">
      <!-- P0 Security: Secure photo loading via backend proxy -->
      @if (photoSrc() && !photoError()) {
      <img class="restaurant-photo" [src]="getCurrentPhotoSrc()" [alt]="restaurant().name + ' restaurant photo'"
        loading="lazy" (error)="onPhotoError()" [attr.aria-label]="'Photo of ' + restaurant().name" />
      } @else {
      <div class="restaurant-photo-placeholder" role="img"
        [attr.aria-label]="'Placeholder image for ' + restaurant().name">
        üçΩÔ∏è
      </div>
      }

      <div class="restaurant-info">
        <div class="restaurant-name-row">
          <h3 class="restaurant-name">{{ restaurant().name }}</h3>

          @if (statusLine().text) {
          <span class="status-line" [class.open]="statusLine().tone === 'open'"
            [class.closed]="statusLine().tone === 'closed'" 
            [class.closing-soon]="statusLine().tone === 'closing-soon'"
            [class.neutral]="statusLine().tone === 'neutral'"
            [attr.aria-label]="statusLine().text">
            {{ statusLine().text }}
          </span>
          }

          @if (glutenFreeBadge()) {
          <span class="dietary-badge gluten-free" [class.high]="glutenFreeBadge()!.level === 'high'"
            [class.low]="glutenFreeBadge()!.level === 'low'" [title]="getGlutenFreeTooltip()">
            {{ glutenFreeBadge()!.text }}
          </span>
          }
        </div>

        <div class="restaurant-meta">
          <div class="meta-left">
            @if (restaurant().rating) {
            <span class="rating" [attr.aria-label]="'Rating: ' + restaurant().rating">
              <span class="rating-value">{{ restaurant().rating }}</span>
              @if (restaurant().userRatingsTotal) {
              <span class="rating-count">({{ restaurant().userRatingsTotal }})</span>
              }
            </span>
            }

            @if (restaurant().priceLevel) {
            <span class="price-level" [attr.aria-label]="'Price level: ' + restaurant().priceLevel">
              {{ getPriceLevel(restaurant().priceLevel) }}
            </span>
            }
          </div>

          @if (distanceInfo()) {
          <span class="distance-text" 
                [class.mode-walking]="distanceInfo()!.mode === 'walking'"
                [class.mode-short-drive]="distanceInfo()!.mode === 'short-drive'"
                [class.mode-far]="distanceInfo()!.mode === 'far'"
                [attr.aria-label]="'Distance: ' + distanceInfo()!.text">
            {{ distanceInfo()!.text }}
          </span>
          }
        </div>

        <p class="restaurant-address">{{ restaurant().address }}</p>
      </div>
    </div>
  </div>

  <!-- Bottom action bar (not clickable for card details) -->
  <div class="action-bar" (click)="$event.stopPropagation()">
    <!-- Provider CTAs (Wolt, 10bis, Mishloha) -->
    @for (cta of providerCtas(); track cta.id) {
      <button type="button" 
        [class]="cta.className"
        [disabled]="cta.disabled"
        (click)="onProviderAction($event, cta.id)"
        [title]="cta.title"
        [attr.aria-label]="cta.ariaLabel">
        @if (cta.showSpinner) {
          <span class="action-spinner">‚è≥</span>
        } @else {
          <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
        }
        <span class="action-label">{{ cta.label }}</span>
      </button>
    }

    <button type="button" class="action-btn" (click)="onAction($event, 'GET_DIRECTIONS')"
      [disabled]="!isActionAvailable('GET_DIRECTIONS')" [title]="getDirectionsTitle()"
      [attr.aria-label]="getDirectionsAriaLabel()">
      <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
        <circle cx="12" cy="10" r="3" />
      </svg>
      <span class="action-label">{{ getNavigateLabel() }}</span>
    </button>

    <button type="button" class="action-btn" (click)="onAction($event, 'CALL_RESTAURANT')"
      [disabled]="!isActionAvailable('CALL_RESTAURANT')" [title]="getCallTitle()"
      [attr.aria-label]="getCallAriaLabel()">
      <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z" />
      </svg>
      <span class="action-label">{{ getCallLabel() }}</span>
    </button>
  </div>
</article>