<article class="restaurant-card" [class.selected]="selected()" [class.top-result]="isTopResult()"
  [class.compact]="compact()" [class.closed]="getOpenStatus() === 'closed'" role="button" tabindex="0"
  [attr.aria-label]="'View details for ' + restaurant().name">
  @if (showReasonLabel() && isTopResult()) {
  <app-reason-label [restaurant]="restaurant()" />
  }

  <!-- P0 Security: Secure photo loading via backend proxy -->
  <!-- Non-blocking: Show placeholder first, load photo after initial render -->
  @if (shouldLoadPhoto() && photoSrc() && !photoError()) {
  <img class="restaurant-photo" [src]="getCurrentPhotoSrc()" [alt]="restaurant().name + ' restaurant photo'"
    loading="lazy" (error)="onPhotoError()" [attr.aria-label]="'Photo of ' + restaurant().name" />
  } @else {
  <div class="restaurant-photo-placeholder" role="img" [attr.aria-label]="'Placeholder image for ' + restaurant().name">
    ğŸ½ï¸
  </div>
  }

  <div class="restaurant-info" (click)="onCardClick()">
    <div class="restaurant-name-row">
      <h3 class="restaurant-name clickable">{{ restaurant().name }}</h3>

      @if (glutenFreeBadge()) {
      <span class="dietary-badge gluten-free" [class.high]="glutenFreeBadge()!.level === 'high'"
        [class.low]="glutenFreeBadge()!.level === 'low'" [title]="getGlutenFreeTooltip()">
        {{ glutenFreeBadge()!.text }}
      </span>
      }
    </div>

    <!-- NEW: Cuisine/category tag -->
    <p class="cuisine-tag">{{ getCuisineTag() }}</p>

    <div class="restaurant-meta">
      @if (restaurant().rating) {
      <span class="rating" [attr.data-low-reviews]="isLowReviewCount() ? 'true' : 'false'"
        [attr.aria-label]="'Rating: ' + restaurant().rating">
        â­ {{ restaurant().rating }}
        @if (restaurant().userRatingsTotal) {
        <span class="rating-reviews"> Â· {{ formatReviewCount(restaurant().userRatingsTotal!) }} ×‘×™×§×•×¨×•×ª</span>
        }
      </span>
      }

      @if (restaurant().priceLevel) {
      <span class="price-level" [attr.aria-label]="'Price level: ' + restaurant().priceLevel">
        {{ getPriceLevel(restaurant().priceLevel) }}
      </span>
      }
    </div>

    <!-- NEW: Compact city + distance -->
    <p class="restaurant-address-compact">{{ getCompactAddress() }}</p>

    <!-- UX SIGNALS: Canonical card signal (priority-based) -->
    @if (cardSignal()) {
    <p class="card-signal-text" [class.emphasized]="isCardSignalEmphasized()" [style.color]="getCardSignalColor()"
      [attr.aria-label]="'Signal: ' + getCardSignalLabel()">
      {{ getCardSignalLabel() }}
      @if (getOpenStatus() === 'closed' && getOpeningTime()) {
      <span class="opening-time"> Â· {{ getOpeningTime() }}</span>
      }
    </p>
    }
  </div>

  <!-- NEW: Horizontal action bar with labels -->
  <div class="action-bar" (click)="$event.stopPropagation()">
    <button type="button" class="action-button" (click)="onAction($event, 'GET_DIRECTIONS')"
      [disabled]="!isActionAvailable('GET_DIRECTIONS')"
      [title]="isActionAvailable('GET_DIRECTIONS') ? 'Navigate to restaurant' : 'Location not available'"
      [attr.aria-label]="isActionAvailable('GET_DIRECTIONS') ? 'Navigate to ' + restaurant().name : 'Location not available'">
      <span class="action-icon">ğŸ“</span>
      <span class="action-label">Navigate</span>
    </button>
    <button type="button" class="action-button" (click)="onAction($event, 'CALL_RESTAURANT')"
      [disabled]="!isActionAvailable('CALL_RESTAURANT')"
      [title]="isActionAvailable('CALL_RESTAURANT') ? 'Call restaurant' : 'Phone number not available'"
      [attr.aria-label]="isActionAvailable('CALL_RESTAURANT') ? 'Call ' + restaurant().name : 'Phone number not available'">
      <span class="action-icon">ğŸ“</span>
      <span class="action-label">Call</span>
    </button>
    <button type="button" class="action-button" (click)="onAction($event, 'SAVE_FAVORITE')"
      [disabled]="!isActionAvailable('SAVE_FAVORITE')" title="Save to favorites"
      [attr.aria-label]="'Save ' + restaurant().name + ' to favorites'">
      <span class="action-icon">â¤ï¸</span>
      <span class="action-label">Save</span>
    </button>
  </div>
</article>