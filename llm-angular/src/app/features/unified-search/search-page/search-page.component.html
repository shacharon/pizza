<div class="search-page">
  <!-- Hero Section (collapses on scroll) -->
  <div class="hero-section" [class.collapsed]="isHeroCollapsed()">
    <h1 class="page-title">Search food the way you think</h1>
    <p class="page-subtitle">Natural food search. Just tell us what you're in the mood for.</p>

    <!-- PWA Install Prompt (V1: English only) -->
    <div class="pwa-install-prompt">
      <button class="pwa-install-button" (click)="onInstallPwa()" type="button">
        <span class="pwa-install-text">Put us on your plate üçΩÔ∏è</span>
      </button>
    </div>

    <!-- Location Status (automatic, inline) -->
    <div class="location-status">
      @if (locationState() === 'ON') {
      <span class="location-text">üìç Using your location</span>
      } @else if (locationState() === 'REQUESTING') {
      <span class="location-text">‚è≥ Getting location...</span>
      } @else if (locationState() === 'DENIED') {
      <span class="location-text location-error">üö´ Location access denied</span>
      } @else if (locationState() === 'ERROR') {
      <span class="location-text location-error">‚ö†Ô∏è Location unavailable</span>
      } @else {
      <button class="location-link" (click)="onLocationToggle()">Enable location for better results</button>
      }
    </div>
  </div>

  <!-- SearchDock (sticky on scroll) -->
  <div class="search-dock">
    <!-- Assistant Line (always shown - includes WS status) -->
    @if (facade.assistantLineMessages().length > 0) {
    <div class="assistant-line-container compact">
      <app-assistant-line />
    </div>
    }

    <!-- Reply Box Input (above assistant) -->
    <div class="search-input-wrapper">
      <app-search-bar [value]="facade.query()" [loading]="facade.loading()" (search)="onSearch($event)"
        (inputChange)="onInputChange($event)" (clear)="onClear()" />
    </div>

    <!-- CANONICAL ROUTING: Contextual Assistant (under input) -->
    @if (showContextualAssistantToggle()) {
    <div class="assistant-toggle-row">
      <button type="button" class="assistant-toggle-btn" (click)="toggleAssistantSummary()" aria-expanded="false">
        <span class="assistant-toggle-icon">‚ú®</span>
        <span class="assistant-toggle-label">Show why</span>
      </button>
    </div>
    }
    @if (showContextualAssistantExpanded()) {
    <div class="assistant-message-container compact">
      @if (isContextualAssistantSummaryOnly() && assistantSummaryExpanded()) {
      <button type="button" class="assistant-hide-link" (click)="toggleAssistantSummary()">Hide</button>
      }
      <app-assistant-summary [cardMessages]="contextualCardMessages()" [messages]="contextualMessages()"
        [text]="asyncAssistantMessage()" [status]="facade.assistantState()" [error]="facade.assistantError()"
        [locale]="'en'" />
    </div>
    }

    <!-- CANONICAL ROUTING: Global/System Assistant (under input) -->
    @if (showGlobalAssistantToggle()) {
    <div class="assistant-toggle-row">
      <button type="button" class="assistant-toggle-btn" (click)="toggleAssistantSummary()" aria-expanded="false">
        <span class="assistant-toggle-icon">‚ú®</span>
        <span class="assistant-toggle-label">Show why</span>
      </button>
    </div>
    }
    @if (showGlobalAssistantExpanded()) {
    <div class="assistant-message-container compact">
      @if (isGlobalAssistantSummaryOnly() && assistantSummaryExpanded()) {
      <button type="button" class="assistant-hide-link" (click)="toggleAssistantSummary()">Hide</button>
      }
      <app-assistant-summary [cardMessages]="globalCardMessages()" [messages]="globalMessages()"
        [text]="asyncAssistantMessage()" [status]="facade.assistantState()" [error]="facade.assistantError()"
        [locale]="'en'" />
    </div>
    }
  </div>

  <!-- Results Frame (normal page flow) -->
  <main class="results-frame">
    <!-- Recent Searches (shown when input is empty) -->
    @if (facade.showRecentSearches() && facade.hasRecentSearches()) {
    <section class="recent-searches">
      <div class="section-header">
        <h2>Recent Searches</h2>
        <button class="clear-link" (click)="onClearRecentSearches()">
          Clear all
        </button>
      </div>
      <ul class="recent-list">
        @for (query of facade.recentSearchesList(); track query) {
        <li class="recent-item" (click)="onRecentSearchClick(query)">
          <span class="recent-icon">üïê</span>
          <span class="recent-query">{{ query }}</span>
        </li>
        }
      </ul>
    </section>
    }

    <!-- Loading State -->
    @if (facade.loading()) {
    <div class="loading-state">
      <div class="loading-spinner">üîç</div>
      <p>Searching for restaurants...</p>
    </div>
    }

    <!-- Error State -->
    @if (facade.error() && !facade.loading()) {
    <div class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h2>Oops! Something went wrong</h2>
      <p>{{ facade.error() }}</p>
      <button class="retry-button" (click)="retry()">
        Try Again
      </button>
    </div>
    }

    <!-- Clarification Block -->
    @if (facade.requiresClarification() && facade.clarification() && !facade.loading()) {
    <app-clarification-block [clarification]="facade.clarification()!"
      (choiceSelected)="onClarificationChoice($event)" />
    }

    <!-- Mode Indicators -->
    @if (isRecoveryMode() && !facade.loading()) {
    <div class="mode-indicator recovery">
      <span class="mode-icon">üîÑ</span>
      <span class="mode-text">Recovery mode - refining search</span>
    </div>
    }

    @if (isClarifyMode() && !facade.loading()) {
    <div class="mode-indicator clarify">
      <span class="mode-icon">‚ùì</span>
      <span class="mode-text">Need more info</span>
    </div>
    }

    <!-- Results Section -->
    @if (shouldShowResults() && !facade.hasGroups() && !facade.loading()) {
    <section class="results-section">
      <div class="results-header">
        <!-- Applied Filters Chips (V1: English only) -->

      </div>

      <!-- Results Container -->
      <div class="results-container">
        <div class="results-grid">
          @for (restaurant of filteredResults(); track trackByRestaurant($index, restaurant)) {
          <app-restaurant-card [restaurant]="restaurant" [selected]="facade.selectedRestaurant()?.id === restaurant.id"
            [userLocation]="locationCoords()" (cardClick)="onCardClick($event)"
            (actionClick)="onActionClick($event, restaurant)" />
          }
        </div>

        <!-- Load More Button -->
        @if (hasMoreResults()) {
        <div class="load-more-container">
          <button class="load-more-btn" (click)="loadMore()">
            Load more
          </button>
        </div>
        }

        <!-- Bottom Gutter -->
        <div class="results-bottom-gutter"></div>
      </div>
    </section>
    }

    <!-- Mobile: Bottom Sheet -->
    @if (showContextualAssistant()) {
    <app-assistant-bottom-sheet [visible]="bottomSheetVisible()" [highlightedResults]="highlightedResults()"
      [userLocation]="locationCoords()" (close)="closeBottomSheet()"
      (restaurantClick)="onCardClick($event); closeBottomSheet()" />
    }

    <!-- Pending Actions Panel -->
    @if (facade.pendingActions().length > 0) {
    <aside class="pending-actions-panel">
      <h3>Pending Approvals</h3>
      @for (action of facade.pendingActions(); track trackByAction($index, action)) {
      <div class="pending-action">
        <div class="action-info">
          <p class="action-restaurant">{{ action.restaurant.name }}</p>
          <p class="action-type">{{ action.type }}</p>
        </div>
        <div class="action-buttons">
          <button class="approve-button" (click)="onApproveAction(action.id)">
            ‚úì Approve
          </button>
          <button class="reject-button" (click)="onRejectAction(action.id)">
            ‚úó Reject
          </button>
        </div>
      </div>
      }
    </aside>
    }
  </main>
</div>