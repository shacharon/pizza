<div class="search-page">
  <header class="search-header">
    <h1 class="page-title">Find Your Perfect Restaurant</h1>
    <app-search-bar
      [loading]="facade.loading()"
      (search)="onSearch($event)"
      (inputChange)="onInputChange($event)"
      (clear)="onClear()"
    />
  </header>

  <main class="search-content">
    <!-- Recent Searches (shown when input is empty) -->
    @if (facade.showRecentSearches() && facade.hasRecentSearches()) {
      <section class="recent-searches">
        <div class="section-header">
          <h2>Recent Searches</h2>
          <button class="clear-link" (click)="onClearRecentSearches()">
            Clear all
          </button>
        </div>
        <ul class="recent-list">
          @for (query of facade.recentSearchesList(); track query) {
            <li class="recent-item" (click)="onRecentSearchClick(query)">
              <span class="recent-icon">üïê</span>
              <span class="recent-query">{{ query }}</span>
            </li>
          }
        </ul>
      </section>
    }

    <!-- Popular Searches (shown when no results and no recent searches) -->
    @if (!facade.hasResults() && !facade.loading() && !facade.error() && !facade.showRecentSearches()) {
      <section class="popular-searches">
        <h2>Popular Searches</h2>
        <div class="search-grid">
          @for (item of popularSearches; track item.query) {
            <button
              class="popular-item"
              (click)="onPopularSearchClick(item.query)"
            >
              <span class="popular-emoji">{{ item.emoji }}</span>
              <span class="popular-label">{{ item.label }}</span>
            </button>
          }
        </div>
      </section>
    }

    <!-- Loading State -->
    @if (facade.loading()) {
      <div class="loading-state">
        <div class="loading-spinner">üîç</div>
        <p>Searching for restaurants...</p>
      </div>
    }

    <!-- Error State -->
    @if (facade.error() && !facade.loading()) {
      <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h2>Oops! Something went wrong</h2>
        <p>{{ facade.error() }}</p>
        <button class="retry-button" (click)="retry()">
          Try Again
        </button>
      </div>
    }

    <!-- NEW: Clarification Block (Answer-First UX) -->
    @if (facade.requiresClarification() && facade.clarification() && !facade.loading()) {
      <app-clarification-block
        [clarification]="facade.clarification()!"
        (choiceSelected)="onClarificationChoice($event)"
      />
    }

    <!-- Phase 5: Mode Indicators (subtle, non-intrusive) -->
    @if (isRecoveryMode() && !facade.loading()) {
      <div class="mode-indicator recovery">
        <span class="mode-icon">üîÑ</span>
        <span class="mode-text">Recovery mode - refining search</span>
      </div>
    }

    @if (isClarifyMode() && !facade.loading()) {
      <div class="mode-indicator clarify">
        <span class="mode-icon">‚ùì</span>
        <span class="mode-text">Need more info</span>
      </div>
    }

    <!-- NEW: Mobile-First Ranked Results -->
    @if (facade.hasResults() && !facade.loading()) {
      <div class="search-results-layout">
        <!-- Primary Results (scrollable) -->
        <section class="results-primary">
          <div class="results-header">
            <h2>
              Found {{ flatResults().length }} restaurant{{ flatResults().length !== 1 ? 's' : '' }}
            </h2>
            @if (facade.meta()) {
              <p class="search-time">
                Searched in {{ facade.meta()!.tookMs }}ms
                @if (facade.meta()!.confidence) {
                  ¬∑ Confidence: {{ (facade.meta()!.confidence * 100).toFixed(0) }}%
                }
              </p>
            }
          </div>
          
          <!-- Phase 8: Disclosure Banner (transparency for derived filters) -->
          @if (showClosedDisclosure() && facade.meta()?.openNowSummary) {
            <app-disclosure-banner
              [summary]="facade.meta()!.openNowSummary!"
              [filterActive]="closedFilterActive()"
            />
          }
          
          <!-- Mobile: Chips above list -->
          @if (facade.chips().length > 0) {
            <div class="chips-mobile">
              @for (chip of facade.chips(); track trackByChip($index, chip)) {
                <button class="chip" (click)="onChipClick(chip.id)">
                  <span>{{ chip.emoji }}</span>
                  {{ chip.label }}
                </button>
              }
            </div>
          }
          
          <app-ranked-results
            [results]="flatResults()"
            [loading]="facade.loading()"
            (restaurantClick)="onCardClick($event)"
          />
        </section>
        
        <!-- Desktop: Sticky Assistant Panel (Conditional - only when needed) -->
        @if (facade.assist() && showAssistant()) {
          <app-assistant-desktop-panel
            class="assistant-desktop"
            [assist]="facade.assist()!"
            [chips]="[]"
            [highlightedResults]="highlightedResults()"
            (restaurantClick)="onCardClick($event)"
          />
        }
      </div>
    }

    <!-- Fallback: Flat Results Grid (backward compatibility) -->
    @if (facade.hasResults() && !facade.hasGroups() && !facade.loading()) {
      <section class="results-section">
        <div class="results-header">
          <h2>
            Found {{ facade.results().length }} restaurant{{ facade.results().length !== 1 ? 's' : '' }}
          </h2>
          @if (facade.meta()) {
            <p class="search-time">
              Searched in {{ facade.meta()!.tookMs }}ms
              @if (facade.meta()!.confidence) {
                ¬∑ Confidence: {{ (facade.meta()!.confidence * 100).toFixed(0) }}%
              }
            </p>
          }
        </div>

        <div class="results-grid">
          @for (restaurant of facade.results(); track trackByRestaurant($index, restaurant)) {
            <app-restaurant-card
              [restaurant]="restaurant"
              [selected]="facade.selectedRestaurant()?.id === restaurant.id"
              (cardClick)="onCardClick($event)"
              (actionClick)="onActionClick($event, restaurant)"
            />
          }
        </div>
      </section>
    }

    <!-- Mobile: Bottom Sheet (Conditional - only when assistant shown) -->
    @if (showAssistant()) {
      <app-assistant-bottom-sheet
        [visible]="bottomSheetVisible()"
        [highlightedResults]="highlightedResults()"
        (close)="closeBottomSheet()"
        (restaurantClick)="onCardClick($event); closeBottomSheet()"
      />
    }

    <!-- Pending Actions Panel -->
    @if (facade.pendingActions().length > 0) {
      <aside class="pending-actions-panel">
        <h3>Pending Approvals</h3>
        @for (action of facade.pendingActions(); track trackByAction($index, action)) {
          <div class="pending-action">
            <div class="action-info">
              <p class="action-restaurant">{{ action.restaurant.name }}</p>
              <p class="action-type">{{ action.type }}</p>
            </div>
            <div class="action-buttons">
              <button
                class="approve-button"
                (click)="onApproveAction(action.id)"
              >
                ‚úì Approve
              </button>
              <button
                class="reject-button"
                (click)="onRejectAction(action.id)"
              >
                ‚úó Reject
              </button>
            </div>
          </div>
        }
      </aside>
    }
  </main>
</div>
