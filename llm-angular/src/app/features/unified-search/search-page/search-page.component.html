<div class="search-page" dir="ltr">
  <header class="search-header" [class.results-mode]="isResultsMode()">
    <div class="search-header-inner">
      <!-- Hero Section: Only show when NOT in results mode -->
      @if (!isResultsMode()) {
      <div class="hero-section">
        <h1 class="page-title">{{ t(uiLanguage(), 'hero.title') }}</h1>
        <p class="page-subtitle">{{ t(uiLanguage(), 'hero.subtitle') }}</p>

        <!-- Location Status (automatic, inline) -->
        <div class="location-status">
          @if (locationState() === 'ON') {
          <span class="location-text">{{ t(uiLanguage(), 'location.using') }}</span>
          } @else if (locationState() === 'REQUESTING') {
          <span class="location-text">{{ t(uiLanguage(), 'location.getting') }}</span>
          } @else if (locationState() === 'DENIED') {
          <span class="location-text location-error">{{ t(uiLanguage(), 'location.denied') }}</span>
          } @else if (locationState() === 'ERROR') {
          <span class="location-text location-error">{{ t(uiLanguage(), 'location.unavailable') }}</span>
          } @else {
          <button class="location-link" (click)="onLocationToggle()">{{ t(uiLanguage(), 'location.enable') }}</button>
          }
        </div>
      </div>
      }

      <!-- Search Card: Input + Assistant Line + Contextual Assistant -->
      <div class="search-card">
        <app-search-bar [value]="facade.currentQuery()" [loading]="facade.loading()"
          [placeholder]="t(uiLanguage(), 'search.placeholder')" (search)="onSearch($event)" (inputChange)="onInputChange($event)"
          (clear)="onClear()" />

        <!-- Assistant Line (always shown - includes WS status) -->
        <div class="search-meta-row">
          <app-assistant-line />
        </div>

        <!-- CANONICAL ROUTING: Contextual Assistant (inside search-card when bound to requestId) -->
        <!-- Shows ONLY card messages: SUMMARY, CLARIFY, GATE_FAIL -->
        @if (showContextualAssistant()) {
        <app-assistant-summary [cardMessages]="contextualCardMessages()" [messages]="contextualMessages()"
          [text]="asyncAssistantMessage()" [status]="facade.assistantState()" [error]="facade.assistantError()"
          [locale]="uiLanguage()" />
        }
      </div>

      <!-- CANONICAL ROUTING: Global/System Assistant (outside search-card, no requestId) -->
      <!-- Shows ONLY card messages: SUMMARY, CLARIFY, GATE_FAIL -->
      @if (showGlobalAssistant()) {
      <app-assistant-summary [cardMessages]="globalCardMessages()" [messages]="globalMessages()"
        [text]="asyncAssistantMessage()" [status]="facade.assistantState()" [error]="facade.assistantError()"
        [locale]="uiLanguage()" />
      }
    </div>
  </header>

  <main class="search-content">
    <!-- Recent Searches (shown when input is empty) -->
    @if (facade.showRecentSearches() && facade.hasRecentSearches()) {
    <section class="recent-searches">
      <div class="section-header">
        <h2>{{ t(uiLanguage(), 'recent.title') }}</h2>
        <button class="clear-link" (click)="onClearRecentSearches()">
          {{ t(uiLanguage(), 'recent.clearAll') }}
        </button>
      </div>
      <ul class="recent-list">
        @for (query of facade.recentSearchesList(); track query) {
        <li class="recent-item" (click)="onRecentSearchClick(query)">
          <span class="recent-icon">üïê</span>
          <span class="recent-query">{{ query }}</span>
        </li>
        }
      </ul>
    </section>
    }

    <!-- Cuisine chips removed - discovery via free-text search + assistant only -->

    <!-- Error State -->
    @if (facade.error() && !facade.loading()) {
    <div class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h2>{{ t(uiLanguage(), 'error.title') }}</h2>
      <p>{{ facade.error() }}</p>
      <button class="retry-button" (click)="retry()">
        {{ t(uiLanguage(), 'error.retry') }}
      </button>
    </div>
    }

    <!-- NEW: Clarification Block (Answer-First UX) -->
    @if (facade.requiresClarification() && facade.clarification() && !facade.loading()) {
    <app-clarification-block [clarification]="facade.clarification()!"
      (choiceSelected)="onClarificationChoice($event)" />
    }

    <!-- Phase 5: Mode Indicators (subtle, non-intrusive) -->
    @if (isRecoveryMode() && !facade.loading()) {
    <div class="mode-indicator recovery">
      <span class="mode-icon">üîÑ</span>
      <span class="mode-text">{{ t(uiLanguage(), 'mode.recovery') }}</span>
    </div>
    }

    @if (isClarifyMode() && !facade.loading()) {
    <div class="mode-indicator clarify">
      <span class="mode-icon">‚ùì</span>
      <span class="mode-text">{{ t(uiLanguage(), 'mode.clarify') }}</span>
    </div>
    }

    <!-- GATE_FAIL UX: Hide results section if GATE_FAIL with no results -->
    <!-- Fallback: Flat Results Grid (backward compatibility) -->
    @if (shouldShowResults() && !facade.hasGroups() && !facade.loading()) {
    <section class="results-section">
      <!-- DEDUPE FIX: Removed "Found X restaurants" header -->
      <!-- Assistant SUMMARY message (from WS) is the only result announcement -->

      <div class="results-header">
        <!-- Order Profile (Deterministic Ranking - NEW) -->
        <!-- ALWAYS RENDER (P0 Fix): Show order badge even if meta.order missing (fallback to defaults) -->
        <div class="order-explain">
          <div class="order-explain-header">
            <span class="order-label">{{ t(uiLanguage(), 'order.label') }}</span>
            <span class="order-profile">{{ hybridBadgeText() }}</span>
            <!-- DEV-ONLY: Debug info -->
            @if (orderDebugInfo()) {
            <span class="order-debug"
              title="Debug: preset={{ orderDebugInfo()!.preset }}, method={{ orderDebugInfo()!.method }}, req={{ orderDebugInfo()!.requestId }}">
              ‚öôÔ∏è
            </span>
            }
          </div>
          <div class="order-explain-details">
            <span class="order-weights">
              @if (orderWeights().rating > 0) {
              <span class="weight-item">‚≠ê {{ orderWeights().rating }}%</span>
              }
              @if (orderWeights().reviews > 0) {
              <span class="weight-item">üí¨ {{ orderWeights().reviews }}%</span>
              }
              @if (orderWeights().price > 0) {
              <span class="weight-item">üí∞ {{ orderWeights().price }}%</span>
              }
              @if (orderWeights().openNow > 0) {
              <span class="weight-item">üü¢ {{ orderWeights().openNow }}%</span>
              }
              @if (orderWeights().distance > 0) {
              <span class="weight-item">üìç {{ orderWeights().distance }}%</span>
              }
            </span>
          </div>
        </div>

        <!-- Applied Filters Chips -->
        <div class="applied-filters">
          @if (closedFilterActive() === 'open') {
          <span class="filter-chip open-now"
            [title]="t(uiLanguage(), 'filter.openNowTooltip')">
            {{ t(uiLanguage(), 'filter.openNow') }}
          </span>
          }
          @if (glutenFreeFilterActive()) {
          <span class="filter-chip gluten-free"
            [title]="t(uiLanguage(), 'filter.glutenFreeTooltip')">
            {{ t(uiLanguage(), 'filter.glutenFree') }}
          </span>
          }
        </div>
      </div>

      <div class="results-grid">
        @for (restaurant of visibleResults(); track trackByRestaurant($index, restaurant)) {
        <app-restaurant-card [restaurant]="restaurant" [selected]="facade.selectedRestaurant()?.id === restaurant.id"
          (cardClick)="onCardClick($event)" (actionClick)="onActionClick($event, restaurant)" />
        }
      </div>

      <!-- Pagination: Load more button (no count shown) -->
      @if (canShowMore()) {
      <div class="pagination-controls">
        <button class="show-more-button" (click)="loadMore()">
          {{ t(uiLanguage(), 'pagination.loadMore') }}
        </button>
      </div>
      }
    </section>
    }

    <!-- Mobile: Bottom Sheet (Conditional - only when contextual assistant shown) -->
    @if (showContextualAssistant()) {
    <app-assistant-bottom-sheet [visible]="bottomSheetVisible()" [highlightedResults]="highlightedResults()"
      (close)="closeBottomSheet()" (restaurantClick)="onCardClick($event); closeBottomSheet()" />
    }

    <!-- Pending Actions Panel -->
    @if (facade.pendingActions().length > 0) {
    <aside class="pending-actions-panel">
      <h3>{{ t(uiLanguage(), 'actions.pendingTitle') }}</h3>
      @for (action of facade.pendingActions(); track trackByAction($index, action)) {
      <div class="pending-action">
        <div class="action-info">
          <p class="action-restaurant">{{ action.restaurant.name }}</p>
          <p class="action-type">{{ action.type }}</p>
        </div>
        <div class="action-buttons">
          <button class="approve-button" (click)="onApproveAction(action.id)">
            {{ t(uiLanguage(), 'actions.approve') }}
          </button>
          <button class="reject-button" (click)="onRejectAction(action.id)">
            {{ t(uiLanguage(), 'actions.reject') }}
          </button>
        </div>
      </div>
      }
    </aside>
    }
  </main>

  <!-- DEV-ONLY: Language Debug Panel -->
  <app-language-debug-panel [response]="facade.response()" />
</div>