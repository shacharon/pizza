# Route2 Pipeline with Base Filters - Flow Diagram

## Complete Pipeline Flow

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                      USER QUERY                                 β”‚
β”‚              "Χ¤Χ™Χ¦Χ” Χ¤ΧΧ•Χ—Χ” ΧΆΧ›Χ©Χ™Χ• Χ‘ΧΧ ΧΧ‘Χ™Χ‘"                        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚
                             β–Ό
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚    GATE2 STAGE          β”‚
              β”‚  - Food signal: YES     β”‚
              β”‚  - Language: he         β”‚
              β”‚  - Route: CONTINUE      β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚    INTENT STAGE         β”‚
              β”‚  - Route: TEXTSEARCH    β”‚
              β”‚  - Region: IL           β”‚
              β”‚  - Language: he         β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚   ROUTE_LLM STAGE       β”‚
              β”‚  - Mapping: TextSearch  β”‚
              β”‚  - Query: "Χ¤Χ™Χ¦Χ”..."     β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚    BASE_FILTERS_LLM (NEW!)                β”‚
    β”‚  Timeout: 900ms                           β”‚
    β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”   β”‚
    β”‚  β”‚ LLM Call:                          β”‚   β”‚
    β”‚  β”‚ "Extract filters from query"       β”‚   β”‚
    β”‚  β”‚                                    β”‚   β”‚
    β”‚  β”‚ Output: PreGoogleBaseFilters       β”‚   β”‚
    β”‚  β”‚ {                                  β”‚   β”‚
    β”‚  β”‚   language: 'he',                  β”‚   β”‚
    β”‚  β”‚   openNow: true,                   β”‚   β”‚
    β”‚  β”‚   regionHint: 'IL'                 β”‚   β”‚
    β”‚  β”‚ }                                  β”‚   β”‚
    β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”   β”‚
    β”‚  On Failure β†’ Fallback:                   β”‚
    β”‚  { language: 'auto', openNow: false }     β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚    TIGHTEN_FILTERS (NEW!)                 β”‚
    β”‚  Deterministic, <1ms                      β”‚
    β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”   β”‚
    β”‚  β”‚ Language Resolution:               β”‚   β”‚
    β”‚  β”‚  1. uiLanguage (if provided)       β”‚   β”‚
    β”‚  β”‚  2. base.language (he/en)          β”‚   β”‚
    β”‚  β”‚  3. gateLanguage fallback          β”‚   β”‚
    β”‚  β”‚  β†’ 'he'                            β”‚   β”‚
    β”‚  β”‚                                    β”‚   β”‚
    β”‚  β”‚ Region Resolution:                 β”‚   β”‚
    β”‚  β”‚  1. base.regionHint                β”‚   β”‚
    β”‚  β”‚  2. defaultRegion                  β”‚   β”‚
    β”‚  β”‚  β†’ 'IL'                            β”‚   β”‚
    β”‚  β”‚                                    β”‚   β”‚
    β”‚  β”‚ Output: FinalSharedFilters         β”‚   β”‚
    β”‚  β”‚ {                                  β”‚   β”‚
    β”‚  β”‚   language: 'he',                  β”‚   β”‚
    β”‚  β”‚   openNow: true,                   β”‚   β”‚
    β”‚  β”‚   regionCode: 'IL',                β”‚   β”‚
    β”‚  β”‚   disclaimers: {                   β”‚   β”‚
    β”‚  β”‚     hours: true,                   β”‚   β”‚
    β”‚  β”‚     dietary: true                  β”‚   β”‚
    β”‚  β”‚   }                                β”‚   β”‚
    β”‚  β”‚ }                                  β”‚   β”‚
    β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”   β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚   ctx.sharedFilters      β”‚
              β”‚   {                      β”‚
              β”‚     preGoogle: {...},    β”‚
              β”‚     final: {...}         β”‚
              β”‚   }                      β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚   GOOGLE_MAPS STAGE     β”‚
              β”‚  - Has access to filtersβ”‚
              β”‚  - Can apply openNow    β”‚
              β”‚  - Can use language     β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚
                         β–Ό
              β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
              β”‚   BUILD RESPONSE        β”‚
              β”‚  - Include final filtersβ”‚
              β”‚  - Return results       β”‚
              β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

## Before vs After

### BEFORE (No Filters)
```
GATE2 β†’ INTENT β†’ ROUTE_LLM β†’ GOOGLE_MAPS
                                  β†“
                           No filter context
                           No language info
                           No open now filter
```

### AFTER (With Filters)
```
GATE2 β†’ INTENT β†’ ROUTE_LLM β†’ BASE_FILTERS_LLM β†’ TIGHTEN β†’ GOOGLE_MAPS
                                     β†“              β†“            β†“
                              PreGoogle filters  Final    Has full
                                                filters   context
```

## Data Flow Example

```
Query: "Χ¤Χ™Χ¦Χ” Χ¤ΧΧ•Χ—Χ” ΧΆΧ›Χ©Χ™Χ• Χ‘ΧΧ ΧΧ‘Χ™Χ‘"
       (Pizza open now in Tel Aviv)

β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ GATE2                                                  β”‚
β”‚ Output: { foodSignal: 'YES', language: 'he' }          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ INTENT                                                 β”‚
β”‚ Output: { route: 'TEXTSEARCH', region: 'IL' }         β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ ROUTE_LLM                                              β”‚
β”‚ Output: { textQuery: 'Χ¤Χ™Χ¦Χ” Χ‘ΧΧ ΧΧ‘Χ™Χ‘' }                β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ BASE_FILTERS_LLM (~500ms)                              β”‚
β”‚ Input:  query="Χ¤Χ™Χ¦Χ” Χ¤ΧΧ•Χ—Χ” ΧΆΧ›Χ©Χ™Χ• Χ‘ΧΧ ΧΧ‘Χ™Χ‘"             β”‚
β”‚ Output: {                                              β”‚
β”‚   language: 'he',                                      β”‚
β”‚   openNow: true,         β† Detected "Χ¤ΧΧ•Χ—Χ” ΧΆΧ›Χ©Χ™Χ•"     β”‚
β”‚   regionHint: 'IL'       β† Detected "ΧΧ ΧΧ‘Χ™Χ‘"         β”‚
β”‚ }                                                      β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ TIGHTEN_FILTERS (<1ms)                                 β”‚
β”‚ Input:  base + gateLanguage='he' + defaultRegion='IL' β”‚
β”‚ Output: {                                              β”‚
β”‚   language: 'he',        β† From base (already he)      β”‚
β”‚   openNow: true,         β† Pass through                β”‚
β”‚   regionCode: 'IL',      β† From base.regionHint        β”‚
β”‚   disclaimers: {                                       β”‚
β”‚     hours: true,         β† Always added                β”‚
β”‚     dietary: true        β† Always added                β”‚
β”‚   }                                                    β”‚
β”‚ }                                                      β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                             β”‚
                       ctx.sharedFilters
                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ GOOGLE_MAPS                                            β”‚
β”‚ Has access to:                                         β”‚
β”‚  - ctx.sharedFilters.final.openNow = true             β”‚
β”‚  - ctx.sharedFilters.final.language = 'he'            β”‚
β”‚  - ctx.sharedFilters.final.regionCode = 'IL'          β”‚
β”‚                                                        β”‚
β”‚ Can apply:                                             β”‚
β”‚  - Filter by currentOpeningHours.openNow              β”‚
β”‚  - Use language='he' in API request                   β”‚
β”‚  - Use region='IL' for better results                 β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

## Timeline

```
0ms     100ms   200ms   300ms   400ms   500ms   600ms   700ms   800ms   900ms
β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚
β”‚ GATE2 β”‚ INTENTβ”‚ROUTE_LLMβ”‚                                             β”‚
β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚β”€β”€β”€β”€β”€β”€β”€β”‚                                               β”‚
β”‚                       β”‚ BASE_FILTERS_LLM β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚
β”‚                                                         β”‚ Max 900ms   β”‚
β”‚                                                         β”‚ Typical 500ms
β”‚                                                         β”‚             β”‚
β”‚                                                         β”‚TIGHTEN<1ms  β”‚
β”‚                                                         β”‚β”€β”‚           β”‚
β”‚                                                           β”‚GOOGLE_MAPSβ”‚
β”‚                                                           β”‚β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚
```

## Error Handling

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  BASE_FILTERS_LLM        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
           β”‚
           β”β”€ Success β†’ base filters
           β”‚
           β”β”€ Timeout (>900ms) β†’ Fallback
           β”‚    { language: 'auto', openNow: false }
           β”‚
           β”β”€ Zod validation error β†’ Fallback
           β”‚
           β””β”€ Any error β†’ Fallback
                β”‚
                β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  TIGHTEN_FILTERS         β”‚
β”‚  (always succeeds)       β”‚
β”‚  - Resolves 'auto'       β”‚
β”‚  - Adds disclaimers      β”‚
β”‚  - Uppercases region     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

## Key Features

β… **Non-blocking**: Continues even if LLM fails  
β… **Fast timeout**: 900ms max  
β… **Deterministic tightening**: No I/O, <1ms  
β… **Always produces output**: Fallback guarantees filters  
β… **Logging**: Full trace for debugging  
β… **Type-safe**: Zod validation on all data  

## Integration Points

**Where filters are available**:
1. β… `ctx.sharedFilters.preGoogle` (after BASE_FILTERS_LLM)
2. β… `ctx.sharedFilters.final` (after TIGHTEN)
3. π” Google Maps stage (can read and apply)
4. π” Response builder (can include in response)
5. π” Future stages (analytics, caching, etc.)
