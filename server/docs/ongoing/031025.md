## 2025-10-03 — Places flow recap and next-steps context

### Context snapshot

- Backend entry: `POST /api/places/search` → `places.controller.ts` → `PlacesLangGraph.run(...)`.
- Major components: intent (LLM) → mode rules → query builder → strategies (text/nearby/findplace) → normalizer.
- Frontend `PlacesPageComponent` calls the endpoint with text/schema; not in scope today.

### What we changed (and why)

- Deterministic mode selection in `PlacesLangGraph` (reduce LLM variance; align with Maps-like UX):
  - Nearby + rankby=distance only for explicit near-me/closest.
  - City discovery defaults to Text Search; then, when coords exist, an optional Nearby + prominence pass with keyword and explicit radius to keep results within city bounds.
  - Landmark/street discovery uses Text Search anchored to place coords with tight radius.
  - Coords are resolved before any Nearby call; if coords are missing, we fall back to Text Search and annotate with a meta note (no hard error).
- Landmark handling improved (precision):
  - Post-processor upgrades street+city to `place: "<street> <city>"` (e.g., "Allenby Tel Aviv") to geocode reliably.
  - Default Text Search radii tuned: `city=5000`, `place=500`, `coords=1500`.
- Mixed intent (Find Place + topic) is non-blocking:
  - Keep Find Place to obtain coords; then run Text Search anchored to the candidate and return those results with an explanatory `meta.note`.
  - If Find Place fails but a city exists, fall back to city-anchored Text Search with a `meta.note`.
- Added optional `meta.note` to DTO for gentle hints without breaking existing clients.

### Files touched (high level)

- `server/src/services/places/orchestrator/places.langgraph.ts`
  - Mode selection rules, city anchoring pass, dual-path findplace+topic, safe fallbacks, meta.note.
- `server/src/services/places/query/query-builder.service.ts`
  - Default radii (city/landmark/coords), `resolveTargetCoordsAsync`, safer Nearby builder.
- `server/src/services/places/intent/places-intent.service.ts`
  - Prompt nudge (streets/landmarks → target.place with city), relaxed upgrade to place.
- `server/src/services/places/models/types.ts`
  - `MetaInfo` now includes `note?: string` (optional).

### Current behavior rules (concise)

- Nearby + distance: only explicit near-me/closest; omit radius (Google rule).
- Nearby + prominence: use when we want bounded results within a radius (esp. city); include keyword + radius.
- Text Search: default for discovery; always use location + radius when coords exist and set `region`.
- Landmark/street queries anchor to the place coords; city queries anchor to city center.

### Known examples and expected routing

- "eat at Marina Tel Aviv" → Text Search, anchor Marina coords, radius ≈ 500.
- "pizza in Tel Aviv" → Text Search city; nearbyprominence pass for bounding.
- "falafel in Ashdod" → Same as above for Ashdod.
- "pizza near me" (with coords) → Nearby + distance.
- Venue-only ("Azrieli Tel Aviv website") → Find Place (details).

### Open items / risks

- Spillover tuning: confirm city bounding for diverse topics/cuisines in IL/EN.
- Confidence: optionally return LLM confidence and include it in `meta.note` when < 0.7.
- Area qualifiers (north/south/center) detection can be broadened; keep it minimal and language-agnostic.
- Tests: unit tests for mode rules; integration for builder param correctness; E2E for the three modes.
- Logging/metrics: structured logs around chosen mode, coords, radius, tookMs, resultCount; map upstream errors to 4xx/5xx.

### Tomorrow’s concrete goals

1. Add minimal unit tests for mode selection (city vs place; near-me; hard radius present; rich-topic discovery).
2. Add integration tests for builder params (textsearch/nearby/findplace): ensure rankby/radius/keyword correctness.
3. Improve error mapping: translate Google statuses to 400/429/5xx (no generic 500), include safe `meta.note`.
4. Optional: surface `confidence` from LLM and include in `meta.note` for mixed-intent hints.

### How to debug quickly (Cursor/VS Code)

- Use "Server: debug (tsx)" launch config in `server/.vscode/launch.json`.
- Breakpoints: `places.controller.ts` → `places.langgraph.ts` (before/after mode rules) → `query-builder.service.ts` (build params) → `google-places.client.ts` (final URL logs).

### Handy paths

- Controller: `server/src/controllers/places/places.controller.ts`
- Orchestrator: `server/src/services/places/orchestrator/places.langgraph.ts`
- Builder: `server/src/services/places/query/query-builder.service.ts`
- Strategies: `server/src/services/places/strategy/*`
- Types: `server/src/services/places/models/types.ts`

This doc captures the working context so we can resume tomorrow exactly where we left off.




