## 2025-11-22 â€” Places UI Refactor: Phase 1 (English-only, auto-detect language)

### Context

We are refactoring the Places page UI (`/places`) to improve UX and prepare for future multi-language support. This is Phase 1: we use English for both search queries and results display, but we auto-detect the user's input language and region for display purposes.

### Current State (Before)

**UI Controls:**
- Query text input
- Language dropdown (manual selection: Hebrew/English)
- Mode dropdown (textsearch/nearbysearch/findplace)
- "Use my location" button
- Search button

**Results Display:**
- Simple list of place names
- Basic metadata (mode, timing, count)
- No visual hierarchy or cards

**Issues:**
- Language dropdown is redundant (LLM already detects language from text)
- Results display is not user-friendly (no ratings, addresses, or map links)
- No "near me" checkbox for explicit location-based search

### Phase 1 Goals (This Session)

**Language Strategy:**
- Search query: Always English (hardcoded for now)
- Results display: Always English (hardcoded for now)
- Auto-detect user's input language (Hebrew vs English) for display purposes
- Auto-detect user's region (from browser locale) for display purposes
- Keep placeholders/comments in code for Phase 2 translation

**UI Changes:**
- Remove language dropdown â†’ Replace with read-only detected language display
- Keep mode dropdown (for troubleshooting; will remove in Phase 2)
- Add "Near me" checkbox (explicit location-based search)
- Add read-only hints section (detected language + region)
- Improve results display with card layout (name, rating, address, map link)
- Show `meta.note` from backend (hints/explanations)

### Phase 2 Goals (Future)

**Multi-language Translation:**
- LLM detects input language (e.g., Hebrew)
- LLM detects target region (e.g., Israel)
- LLM translates query to region's native language (Hebrew) for Google search
- Google returns results in native language
- LLM translates results back to user's input language
- All translation logic lives in the LLM (no separate translation service)

**UI Cleanup:**
- Remove mode dropdown (LLM decides mode fully)
- Add confidence scores in hints
- Enhanced error messages and suggestions

### UI Mockup (Phase 1)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Places Search                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Query:                                      â”‚
â”‚  [text input.................................] â”‚
â”‚                                              â”‚
â”‚  â˜‘ Near me    Mode: [Text search â–¼]        â”‚
â”‚                                              â”‚
â”‚  ğŸ“ Language: English  |  ğŸŒ Region: IL      â”‚
â”‚  (auto-detected, read-only)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Search]                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Results (5 found in 234ms)                 â”‚
â”‚  â„¹ï¸ Refined results with nearby search...    â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Pizza Place Name                â”‚        â”‚
â”‚  â”‚ â­ 4.5 (120 reviews)            â”‚        â”‚
â”‚  â”‚ ğŸ“ Address here                 â”‚        â”‚
â”‚  â”‚ [View on Map â†’]                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  ...more cards...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Details

#### Component TypeScript Changes

**Removed:**
- `language` signal (no manual dropdown)

**Added:**
- `detectedLanguage` signal: auto-detect from input text (Hebrew vs English)
- `detectedRegion` signal: from browser locale (e.g., 'IL', 'US', 'FR')
- `nearMe` signal: checkbox state for explicit location-based search
- `detectLanguage(text: string)`: heuristic to detect Hebrew vs English
- `detectRegion()`: parse `navigator.language` to extract region code

**Updated:**
- `onQueryInput()`: now calls `detectLanguage()` and updates `detectedLanguage` signal
- `onSubmit()`: always uses `'en'` for language param (Phase 1), passes `nearMe` flag
- Added TODO comments for Phase 2 translation logic

#### Template HTML Changes

**Controls:**
- Query input (unchanged)
- Removed language `<select>` dropdown
- Kept mode `<select>` dropdown (temporary for troubleshooting)
- Added near-me checkbox
- Added read-only hints section (detected language + region)

**Results:**
- Replaced simple `<ul>` list with card grid layout
- Each card shows: name, rating (stars + count), address, "View on Map" link
- Display `meta.note` if present (info box with icon)
- Show results count and timing in header

#### Styles SCSS Changes

- Grid layout for controls (responsive)
- Hints section styling (subtle background, small text, read-only appearance)
- Results grid (auto-fill, responsive cards)
- Place card styling (border, padding, shadow, hover effects)
- Note/hint info box styling (blue background, left border, icon)

### Files Changed

- `llm-angular/docs/ongoing/221125.md` (this file)
- `llm-angular/src/app/features/places/places.models.ts` (new - domain models)
- `llm-angular/src/app/features/places/places.facade.ts` (new - facade service)
- `llm-angular/src/app/features/places/places-page/places-page.component.ts`
- `llm-angular/src/app/features/places/places-page/places-page.component.html`
- `llm-angular/src/app/features/places/places-page/places-page.component.scss`
- `llm-angular/src/app/shared/services/places-api.service.ts` (updated interfaces)

### Testing Plan

1. Test with existing Postman examples (from backend testing):
   - "pizza gluten free in gedera"
   - "falafel in Ashdod"
   - "pizza in Tel Aviv"
   - "eat at Marina Tel Aviv"

2. Verify:
   - Language auto-detection works (Hebrew vs English)
   - Region detection works (from browser locale)
   - Near-me checkbox toggles correctly
   - Mode dropdown still works (for troubleshooting)
   - Results display in card layout with all fields
   - `meta.note` displays when present
   - Map links work correctly

3. Edge cases:
   - Empty query
   - No results
   - Error from backend
   - Missing fields in results (rating, address, etc.)

### Next Steps (After Phase 1)

1. Implement Phase 2 translation logic (LLM-based)
2. Remove mode dropdown (LLM decides fully)
3. Add confidence scores and enhanced hints
4. Add unit tests for language detection
5. Add E2E tests for Places UI flow

### Related Documentation

- Backend Places flow: `server/docs/ongoing/031025.md`
- Backend main goal: `server/docs/ongoing/main-goal.md`

---

## Architecture Improvements (Added during implementation)

### Facade Pattern Implementation

Following Angular best practices, we implemented the **Facade pattern** for better separation of concerns:

**Architecture:**
```
Component â†’ Facade Service â†’ API Service â†’ Backend
   â†“             â†“                â†“
 (UI only)  (Business logic)  (HTTP only)
```

**Benefits:**
1. **Separation of concerns**: Component only handles UI, Facade handles business logic
2. **Testability**: Easier to mock and test each layer
3. **Reusability**: Multiple components can use the same Facade
4. **Type safety**: Strong models in/out (`places.models.ts`)
5. **State management**: Facade manages loading, error, results signals

**New Files:**
- `places.models.ts`: Domain models (PlacesSearchRequest, PlaceItem, PlacesSearchResponse, DetectedContext)
- `places.facade.ts`: Facade service with business logic and state management

**Component Simplification:**
- Component is now purely presentational
- All business logic moved to facade
- Component uses computed signals from facade
- Cleaner, more testable code

### Region Detection Fix

Fixed region detection to correctly show "IL" for Israeli users:
- Changed from `navigator.language` (often returns "en-US") to timezone-based detection
- Uses `Intl.DateTimeFormat().resolvedOptions().timeZone`
- Maps "Asia/Jerusalem" â†’ "IL"
- Falls back to continent mapping, then navigator.language, then "IL"

---

**Status:** Phase 1 implementation completed (2025-11-22)
- âœ… Facade pattern implemented
- âœ… Region detection fixed
- âœ… Strong typing with models
- âœ… All linter errors resolved

