# Complete Search Flow - With Cuisine Enforcement & City Bias

## Example Query: "××¡×¢×“×•×ª ××™×˜×œ×§×™×•×ª ×‘×’×“×¨×”"
(Italian restaurants in Gedera)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER INPUT: "××¡×¢×“×•×ª ××™×˜×œ×§×™×•×ª ×‘×’×“×¨×”"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 1: GATE (25%)                                             â”‚
â”‚ Output: isFoodRelated=true, confidence=0.95                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 2: INTENT (40%)                                           â”‚
â”‚ Output:                                                         â”‚
â”‚   - route: TEXTSEARCH                                           â”‚
â”‚   - reason: "explicit_city_mentioned"                           â”‚
â”‚   - cityText: "×’×“×¨×”"                                            â”‚
â”‚   - regionCandidate: "IL"                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 3: ROUTE_LLM (TextSearch Mapper)                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ§  LLM Analysis:                                            â”‚ â”‚
â”‚ â”‚ - Detects explicit cuisine: "××™×˜×œ×§×™×•×ª"                     â”‚ â”‚
â”‚ â”‚ - Identifies city: "×’×“×¨×”"                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Output:                                                         â”‚
â”‚   - textQuery: "××¡×¢×“×•×ª ××™×˜×œ×§×™×•×ª ×’×“×¨×”"                          â”‚
â”‚   - requiredTerms: ["××™×˜×œ×§×™×ª", "××™×˜×œ×§×™"] â† NEW                â”‚
â”‚   - preferredTerms: ["×¤×¡×˜×”", "×¤×™×¦×”"] â† NEW                    â”‚
â”‚   - strictness: "STRICT" â† NEW                                 â”‚
â”‚   - typeHint: "restaurant" â† NEW                               â”‚
â”‚   - cityText: "×’×“×¨×”"                                            â”‚
â”‚   - region: "IL"                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 4: CITY CENTER RESOLUTION â† NEW                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“ Geocode "×’×“×¨×”":                                          â”‚ â”‚
â”‚ â”‚ 1. Check cache (key: "×’×“×¨×”_IL")                            â”‚ â”‚
â”‚ â”‚ 2. Cache miss â†’ Call Google Geocoding API                  â”‚ â”‚
â”‚ â”‚ 3. Result: {lat: 31.810, lng: 34.777}                      â”‚ â”‚
â”‚ â”‚ 4. Cache for 1 hour                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Output:                                                         â”‚
â”‚   - cityCenter: {lat: 31.810, lng: 34.777}                     â”‚
â”‚                                                                 â”‚
â”‚ Log: city_center_resolved {servedFromCache: false}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 5: GOOGLE TEXT SEARCH (60%)                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸŒ Google Request Body:                                     â”‚ â”‚
â”‚ â”‚ {                                                            â”‚ â”‚
â”‚ â”‚   "textQuery": "××¡×¢×“×•×ª ××™×˜×œ×§×™×•×ª ×’×“×¨×”",                      â”‚ â”‚
â”‚ â”‚   "regionCode": "IL",                                        â”‚ â”‚
â”‚ â”‚   "languageCode": "he",                                      â”‚ â”‚
â”‚ â”‚   "locationBias": { â† NEW (Actually Applied!)               â”‚ â”‚
â”‚ â”‚     "circle": {                                              â”‚ â”‚
â”‚ â”‚       "center": {                                            â”‚ â”‚
â”‚ â”‚         "latitude": 31.810,                                  â”‚ â”‚
â”‚ â”‚         "longitude": 34.777                                  â”‚ â”‚
â”‚ â”‚       },                                                     â”‚ â”‚
â”‚ â”‚       "radius": 10000                                        â”‚ â”‚
â”‚ â”‚     }                                                        â”‚ â”‚
â”‚ â”‚   }                                                          â”‚ â”‚
â”‚ â”‚ }                                                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Output: 25 places (mixed: Italian, burger, sushi, etc.)        â”‚
â”‚                                                                 â”‚
â”‚ Log: google_textsearch_bias_applied {biasType: "cityCenter"}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 5.5: CUISINE ENFORCEMENT â† NEW                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ§  LLM Filter (NO HARDCODED RULES):                         â”‚ â”‚
â”‚ â”‚ Input: 25 places with names/types/addresses                 â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ Analysis:                                                    â”‚ â”‚
â”‚ â”‚ âœ… "Pasta Bar" + italian_restaurant â†’ KEEP                  â”‚ â”‚
â”‚ â”‚ âœ… "Pizza Roma" + pizza_restaurant â†’ KEEP                   â”‚ â”‚
â”‚ â”‚ âœ… "×˜×¨×˜×•×¨×™×” ××™×˜×œ×§×™×ª" + italian_restaurant â†’ KEEP           â”‚ â”‚
â”‚ â”‚ âŒ "Burger King" + fast_food â†’ REJECT                       â”‚ â”‚
â”‚ â”‚ âŒ "×¡×•×©×™ ×‘×¨" + japanese_restaurant â†’ REJECT                â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ Strictness: STRICT (explicit cuisine = "××™×˜×œ×§×™×•×ª")         â”‚ â”‚
â”‚ â”‚ Required: ["××™×˜×œ×§×™×ª", "××™×˜×œ×§×™"]                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Output: 12 Italian restaurants (filtered + reordered)          â”‚
â”‚                                                                 â”‚
â”‚ Logs:                                                           â”‚
â”‚ - cuisine_enforcement_started {countIn: 25}                    â”‚
â”‚ - cuisine_enforcement_completed {countOut: 12}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 6: POST_FILTERS (75%)                                     â”‚
â”‚ Apply: openState, priceIntent, minRating, etc.                 â”‚
â”‚ Output: 10 Italian restaurants (after filters)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 6.5: RANKING (90%)                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“ Distance Calculation:                                    â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ OLD (âŒ):                                                    â”‚ â”‚
â”‚ â”‚   anchor = userLocation (Tel Aviv)                          â”‚ â”‚
â”‚ â”‚   distanceMeters = 30,000m â† WRONG!                        â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ NEW (âœ…):                                                    â”‚ â”‚
â”‚ â”‚   anchor = cityCenter (Gedera)                              â”‚ â”‚
â”‚ â”‚   distanceMeters = 450m â† CORRECT!                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Output: 10 Italian restaurants (ranked by quality + distance)  â”‚
â”‚                                                                 â”‚
â”‚ Log: ranking_distance_source {source: "cityCenter"}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 7: BUILD RESPONSE (100%)                                 â”‚
â”‚ Final: 10 Italian restaurants in Gedera, ranked correctly      â”‚
â”‚                                                                 â”‚
â”‚ Log: final_response_order {orderSource: "ranking"}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparison: Before vs After

### Query: "××¡×¢×“×•×ª ××™×˜×œ×§×™×•×ª ×‘×’×“×¨×”"

| Aspect | Before âŒ | After âœ… |
|--------|----------|----------|
| **Google Bias** | None or wrong | 10km from Gedera center (31.810, 34.777) |
| **Cuisine Filter** | None (mixed results) | LLM-enforced Italian only |
| **Result Count** | 25 (mixed) | 12 (Italian only) |
| **Distance Anchor** | Tel Aviv userLocation | Gedera cityCenter |
| **Distance Range** | 25,000-35,000m | 300-5,000m |
| **Precision** | ~40% (10/25 Italian) | ~95% (12/12 Italian) |

### Query: "×‘×ª×™ ×§×¤×” ×‘××©×§×œ×•×Ÿ"

| Aspect | Before âŒ | After âœ… |
|--------|----------|----------|
| **Google Bias** | None | 10km from Ashkelon center (31.669, 34.571) |
| **Distance Anchor** | Tel Aviv userLocation | Ashkelon cityCenter |
| **Distance Range** | 20,000-30,000m | 0-5,000m |
| **Cache** | None | 1 hour in-memory cache |
| **API Calls** | Every search | First search only |

---

## Log Flow Example

### Successful Flow
```json
// 1. Intent identifies city
{"event": "intent_decided", "route": "TEXTSEARCH", "cityText": "×’×“×¨×”"}

// 2. Mapper extracts cuisine
{"event": "textsearch_mapper_response", "requiredTerms": ["××™×˜×œ×§×™×ª"], "strictness": "STRICT"}

// 3. City center resolved (cached)
{"event": "city_center_resolved", "cityText": "×’×“×¨×”", "lat": 31.810, "lng": 34.777, "servedFromCache": true}

// 4. Bias applied to Google
{"event": "google_textsearch_bias_applied", "biasType": "cityCenter", "lat": 31.810, "lng": 34.777, "radiusMeters": 10000}

// 5. Google returns results
{"event": "google_parallel_completed", "resultCount": 25}

// 6. Cuisine enforcement filters
{"event": "cuisine_enforcement_started", "countIn": 25, "strictness": "STRICT"}
{"event": "cuisine_enforcement_completed", "countOut": 12, "relaxApplied": false}

// 7. Ranking uses city center
{"event": "ranking_distance_source", "source": "cityCenter", "hadUserLocation": true, "hasCityText": true}

// 8. Final response
{"event": "final_response_order", "count": 12, "orderSource": "ranking", "reordered": true}
```

---

## Architecture Principles

1. **LLM-First**: No hardcoded cuisine lists or city tables
2. **Fail-Safe**: Every LLM call has timeout + error handling
3. **Non-Blocking**: Failures return gracefully (all results if enforcement fails)
4. **Cached**: Geocoding cached for 1 hour (reduces API calls)
5. **Observable**: Comprehensive logging at every stage
6. **Testable**: Unit tests for key scenarios
7. **Backward Compatible**: Existing queries work unchanged

---

## Performance Profile

### Typical Query: "××¡×¢×“×•×ª ××™×˜×œ×§×™×•×ª ×‘×’×“×¨×”"

```
Total Time: ~2500ms

Breakdown:
- GATE:              ~300ms
- INTENT:            ~400ms
- ROUTE_LLM:         ~500ms
- CITY_GEOCODE:      ~0ms (cached) or ~300ms (first time)
- GOOGLE:            ~600ms
- CUISINE_ENFORCER:  ~700ms â† NEW
- POST_FILTERS:      ~100ms
- RANKING:           ~400ms
- RESPONSE:          ~100ms
```

### Optimizations
- âœ… City geocoding cached (1 hour TTL)
- âœ… Early exit when no requiredTerms
- âœ… Parallel LLM calls where possible
- âœ… Fail-fast on timeouts

---

Generated: 2026-01-30
