# System Tools & Options - Workspace Rules

## Core Principle
**One intent = one surface. No duplicate controls.**

## Chip Taxonomy (Strict)

Chips must be classified into exactly ONE type:

### FILTER (Multi-Select)
- Changes which results are included
- Multiple filters can be active simultaneously
- Examples: Delivery ğŸš—, Budget ğŸ’°, Open Now ğŸŸ¢
- State: `facade.activeFilters()` (array)

### SORT (Single-Select)
- Changes ordering only
- Exactly ONE sort chip active at a time
- Context-aware: Show when `results.length >= 5` AND `confidence >= 70%`
- Examples: Best Match âœ¨, Closest ğŸ“, Rating â­, Price ğŸ’°
- State: `facade.currentSort()` (single value)
- Default: `BEST_MATCH`

### VIEW (Single-Select)
- Changes presentation mode
- One view active at a time
- Examples: List ğŸ“‹, Map ğŸ—ºï¸
- State: `facade.currentView()` (single value)
- Default: `LIST`

**Critical Rules:**
- "Top Rated â­" is SORT (not filter)
- "Closed Now ğŸ”´" is FILTER (RECOVERY mode only)
- Clicking a sort chip deactivates all other sorts
- Clicking a filter chip toggles it on/off
- Never mix taxonomy (a chip cannot be both FILTER and SORT)

## Authoritative Documentation
The complete reference for all tools, options, chips, and actions is in:
ğŸ“„ `docs/SYSTEM_TOOLS_AND_OPTIONS.md`

This document is the **heart of the system** and must be consulted for:
- Adding new chips or filters
- Modifying chip behavior
- Changing assistant visibility rules
- Adjusting search modes
- Implementing new actions

## Immutable Rules (NEVER Violate)

### 1. Single Control Surface
- **ONLY ONE** chips row for sorting/filtering
- Chips must call `facade.onChipClick(chipId)` (never open modals)
- Never add duplicate chip rows, buttons, or controls
- Desktop and mobile share the same chips row (no separate controls)

### 2. Conditional Assistant
Assistant is **ONLY** visible when:
- No results found, OR
- Confidence < 60%, OR
- Mode is RECOVERY or CLARIFY

**Never show assistant when results are good!**

### 3. Granularity-Based Grouping
Distance grouping **MUST** depend on search granularity:
- **CITY** searches â†’ All results in ONE "EXACT" group (no distance splitting)
- **STREET** searches â†’ "EXACT" (500m) + "NEARBY" (2km)
- **LANDMARK** searches â†’ "EXACT" (1km) + "NEARBY" (3km)
- **AREA** searches â†’ "EXACT" (1.5km) + "NEARBY" (5km)

**Never apply street-level radii to city searches!**

### 4. Mode-Driven Behavior
The system operates in 3 modes. Each mode has different chips:
- **NORMAL** â†’ Context-aware filters + sorts (when 5+ results, 70%+ confidence)
  - Filters: Delivery, Budget, Open Now, Takeout, etc.
  - Sorts: Best Match (default), Closest, Rating, Price
  - Max 5 chips total in NORMAL mode
- **RECOVERY** â†’ Recovery chips (expand, remove filters, try nearby, sort by rating, map)
  - "Closed Now ğŸ”´" chip appears ONLY in RECOVERY when user searched "open" but got 0 results
  - Max 5 recovery chips
- **CLARIFY** â†’ Clarification chips (city suggestions, 1-3 chips max)
  - Minimal set to resolve ambiguity

**Chips MUST match the mode!**

### 5. Mobile-First UX
- Design for mobile first, enhance for desktop
- Same mental model across breakpoints
- Single ranked list (no competing columns or sections)
- Chips row visible on ALL breakpoints

### 6. Result Display Rules
- **ONE ranked list** (best match on top)
- No "EXACT vs NEARBY" grouping for city searches
- Top result shows reason label (e.g., "Best match Â· Open now Â· 4.3â­")
- No re-sorting in the UI (trust backend ranking)

## Implementation Checklist

### When Adding a New Chip:
- [ ] Add chip to `suggestion.service.ts` (mode-aware generation)
- [ ] Add i18n keys to all `translations/{lang}.json` files
- [ ] Add filter/sort logic to backend if needed
- [ ] Update `docs/SYSTEM_TOOLS_AND_OPTIONS.md`
- [ ] Add regression test in `search-page-no-duplication.spec.ts`
- [ ] Verify chip appears ONLY once in the UI

### When Adding a New Action:
- [ ] Add action type to `action.types.ts`
- [ ] Add action button to `restaurant-card.component.html`
- [ ] Add action handler in `restaurant-card.component.ts`
- [ ] Update `docs/SYSTEM_TOOLS_AND_OPTIONS.md`
- [ ] Add i18n labels if needed
- [ ] Test Human-in-the-Loop workflow

### When Modifying Search Modes:
- [ ] Update mode logic in `suggestion.service.ts`
- [ ] Update `showAssistant` computed signal conditions
- [ ] Update `docs/SYSTEM_TOOLS_AND_OPTIONS.md`
- [ ] Add QA dataset entries for new mode scenarios
- [ ] Run full regression suite

### When Changing Grouping Logic:
- [ ] Verify granularity classification in `granularity-classifier.service.ts`
- [ ] Update grouping rules in `search.orchestrator.ts`
- [ ] Update `docs/SYSTEM_TOOLS_AND_OPTIONS.md`
- [ ] Test city searches (no splitting!)
- [ ] Test street/landmark searches (proper radii)

## Testing Requirements

### Regression Tests (Must Pass)
1. **search-page-no-duplication.spec.ts**
   - Only ONE chips row exists
   - Only ONE results list exists
   - NO duplicate assistant strips
   - Assistant conditional logic works

2. **QA Harness (npm run qa)**
   - All 41 canonical queries pass
   - No regressions in NORMAL/RECOVERY/CLARIFY modes
   - Granularity detection correct

### Manual Testing Checklist
- [ ] "pizza in tel aviv" â†’ All results in ONE group (no "nearby" section)
- [ ] "pizza on allenby" â†’ "EXACT" + "NEARBY" sections (street search)
- [ ] Click chip â†’ Results filter immediately (no modal)
- [ ] Good results + high confidence â†’ Assistant hidden
- [ ] No results â†’ Assistant visible with recovery chips
- [ ] Mobile: horizontal scroll chips
- [ ] Desktop: chips wrap to multiple rows

## Quick Reference: Key Files

| Component | Location |
|-----------|----------|
| **Chips Generation** | `server/src/services/search/capabilities/suggestion.service.ts` |
| **Granularity Logic** | `server/src/services/search/detectors/granularity-classifier.service.ts` |
| **Grouping Logic** | `server/src/services/search/orchestrator/search.orchestrator.ts` |
| **Frontend Chips** | `llm-angular/src/app/features/unified-search/search-page/` |
| **Assistant Conditional** | `search-page.component.ts` â†’ `showAssistant` computed |
| **i18n Translations** | `server/src/services/i18n/translations/{lang}.json` |
| **Regression Tests** | `llm-angular/src/app/features/unified-search/search-page/search-page-no-duplication.spec.ts` |
| **QA Dataset** | `server/src/services/search/qa/qa.dataset.json` |

## Common Pitfalls (Avoid!)

âŒ **Adding a second chips row** â†’ Violates single control surface  
âŒ **Making chips open modals** â†’ Chips must trigger actual filtering  
âŒ **Always showing assistant** â†’ Assistant must be conditional  
âŒ **Re-sorting results in UI** â†’ Trust backend ranking  
âŒ **Distance grouping for city searches** â†’ Use granularity-based logic  
âŒ **Duplicate chips in desktop panel** â†’ Pass empty array `[]`  
âŒ **Hardcoded labels** â†’ Always use i18n keys  
âŒ **Skipping regression tests** â†’ Tests enforce core principles  

## Approval Required For

The following changes require explicit user approval:
1. Adding a new control surface (beyond the single chips row)
2. Changing assistant visibility rules
3. Modifying granularity-based grouping logic
4. Adding new search modes (beyond NORMAL/RECOVERY/CLARIFY)
5. Breaking changes to chip behavior or appearance

## Philosophy

> "The heart of the system is giving users **one clear path** to control results. Everything else is assistive, not competitive."

- **One chips row** â†’ Single source of truth
- **One ranked list** â†’ Trust through clarity
- **Conditional assistant** â†’ Help when needed, hide when not
- **Mode-driven** â†’ Adapt to user needs
- **Mobile-first** â†’ Works everywhere

---

**Remember:** This is the **heart of the system**. Consult `docs/SYSTEM_TOOLS_AND_OPTIONS.md` for all implementation details.

